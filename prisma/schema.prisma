generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
}

model Admin {
  id            Int             @id @default(autoincrement())
  username      String          @unique
  password      String
  name          String
  email         String
  role          AdminRole       @default(ADMIN) // ✅ 추가
  isActive      Boolean         @default(true) // ✅ 추가
  createdAt     DateTime        @default(now())
  SoftwareAsset SoftwareAsset[]

  // ✅ 추가: 동적 자산 생성한 목록 (역관계)
  createdAssets AssetEntity[] @relation("AdminCreatedAssets")

    // ... existing fields
  permissionGrants AdminPermissionGrant[]
}

model Department {
  id     Int             @id @default(autoincrement())
  name   String          @unique
  assets SoftwareAsset[]
}

model Vendor {
  id           Int             @id @default(autoincrement())
  name         String          @unique
  contactName  String?
  contactEmail String?
  contactPhone String?
  notes        String?         @db.Text
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  assets       SoftwareAsset[]
}

model SoftwareAsset {
  id               Int               @id @default(autoincrement())
  name             String
  category         AssetCategory
  status           AssetStatus       @default(active)
  expiryDate       DateTime
  ownerAdminId     Int
  vendorId         Int?
  departmentId     Int?
  purchaseDate     DateTime?
  renewalCycle     RenewalCycle?
  autoRenew        Boolean           @default(false)
  cost             Decimal?          @db.Decimal(12, 2)
  currency         String            @default("KRW")
  billingCycle     BillingCycle      @default(monthly)
  seatsTotal       Int?
  seatsUsed        Int?
  purchaseChannel  String?
  description      String?           @db.Text
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  assignments      AssetAssignment[]
  notificationLogs NotificationLog[]
  department       Department?       @relation(fields: [departmentId], references: [id])
  owner            Admin             @relation(fields: [ownerAdminId], references: [id])
  vendor           Vendor?           @relation(fields: [vendorId], references: [id])

  @@index([expiryDate])
  @@index([status])
  @@index([category])
  @@index([vendorId])
  @@index([departmentId])
  @@index([ownerAdminId], map: "SoftwareAsset_ownerAdminId_fkey")
}

model AssetAssignment {
  id         Int           @id @default(autoincrement())
  assetId    Int
  userName   String
  userEmail  String?
  assignedAt DateTime      @default(now())
  returnedAt DateTime?
  notes      String?
  asset      SoftwareAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
}

model NotificationLog {
  id      Int           @id @default(autoincrement())
  assetId Int
  rule    String
  sentAt  DateTime      @default(now())
  asset   SoftwareAsset @relation(fields: [assetId], references: [id])

  @@unique([assetId, rule, sentAt])
}

enum AssetCategory {
  collaboration
  devtool
  designtool
  infrastructure
  security
  other
}

enum AssetStatus {
  active
  expiring
  expired
  terminated
  on_hold
}

enum RenewalCycle {
  m1
  m3
  m6
  y1
  y3
  one_time
}

enum BillingCycle {
  monthly
  yearly
  one_time
  none
}

enum DynamicFieldType {
  text
  textarea
  number
  date
  select
  boolean
}

enum AssetSource {
  MANUAL
  CSV
}

enum AdminPermission {
  ASSET_CSV_IMPORT
  ASSET_TYPE_MANAGE
  ADMIN_MANAGE
}

model AssetType {
  id        Int      @id @default(autoincrement())
  slug      String   @unique
  name      String
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  fields AssetTypeField[]
  assets AssetEntity[]
}

model AssetTypeField {
  id          Int              @id @default(autoincrement())
  typeId      Int
  key         String
  label       String
  fieldType   DynamicFieldType
  required    Boolean          @default(false)
  optionsJson Json?
  order       Int              @default(0)
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())

  type AssetType @relation(fields: [typeId], references: [id])

  @@unique([typeId, key])
  @@index([typeId])
}

model AssetEntity {
  id          Int      @id @default(autoincrement())
  typeId      Int
  title       String
  status      String   @default("ACTIVE")
  data        Json
  createdById Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // ✅ 추가: 생성 경로 (수기/CSV)
  source      AssetSource @default(MANUAL)

  type      AssetType @relation(fields: [typeId], references: [id])
  createdBy Admin?    @relation("AdminCreatedAssets", fields: [createdById], references: [id])

  @@index([typeId])
  @@index([createdById])
}

model AdminPermissionGrant {
  id         Int             @id @default(autoincrement())
  adminId    Int
  permission AdminPermission
  grantedAt  DateTime        @default(now())

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@unique([adminId, permission])
  @@index([adminId])
}

// ✅ 앱 전역 브랜드(로고/사명) 설정 - 단일 row(id=1)를 upsert로 운용
model AppBrand {
  id          Int      @id @default(1)
  companyName String   @default("SpoonMate")
  logoUrl     String?  // 예: /uploads/brand-logo-1700000000000.png
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
